name: Build Extension

on:
  # Allow manual trigger from Actions tab with environment selection
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to build'
        required: true
        type: choice
        options:
          - dev
          - test
          - prod

jobs:
  build:
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build for ${{ github.event.inputs.environment }}
        run: npm run build
        env:
          BUILD_ENV: ${{ github.event.inputs.environment }}

      - name: Create distribution package
        run: |
          # Determine the artifacts subdirectory based on environment
          case "${{ github.event.inputs.environment }}" in
            dev)
              ARTIFACTS_DIR="artifacts/Dev"
              ;;
            test)
              ARTIFACTS_DIR="artifacts/Test"
              ;;
            prod)
              ARTIFACTS_DIR="artifacts/Prod"
              ;;
          esac

          # Check if artifacts directory exists
          if [ ! -d "$ARTIFACTS_DIR" ]; then
            echo "âŒ Error: $ARTIFACTS_DIR not found"
            echo "Available directories:"
            ls -la artifacts/ || echo "No artifacts directory found"
            exit 1
          fi

          # Create a clean distribution directory
          mkdir -p dist

          # Create ZIP file for easy distribution
          cd "$ARTIFACTS_DIR"
          zip -r "../../dist/extension-${{ github.event.inputs.environment }}.zip" .
          cd ../..

          # Copy unzipped files as well
          cp -r "$ARTIFACTS_DIR" "dist/extension-${{ github.event.inputs.environment }}"

          echo "âœ… Created distribution package"
          ls -lh dist/

      - name: Upload ZIP artifact
        uses: actions/upload-artifact@v4
        with:
          name: extension-${{ github.event.inputs.environment }}-v${{ github.run_number }}
          path: dist/extension-${{ github.event.inputs.environment }}.zip
          retention-days: 90

      - name: Upload unzipped artifact
        uses: actions/upload-artifact@v4
        with:
          name: extension-${{ github.event.inputs.environment }}-unzipped-v${{ github.run_number }}
          path: dist/extension-${{ github.event.inputs.environment }}/
          retention-days: 90

      - name: Build summary
        run: |
          echo "### ðŸŽ‰ Build completed successfully!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** \`${{ github.event.inputs.environment }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** \`1.1.9\`" >> $GITHUB_STEP_SUMMARY
          echo "**Build Number:** \`#${{ github.run_number }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“¦ Download Artifacts" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Two artifact types are available:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "1. **ZIP Package** - \`extension-${{ github.event.inputs.environment }}-v${{ github.run_number }}\`" >> $GITHUB_STEP_SUMMARY
          echo "   - Ready to distribute, single file download" >> $GITHUB_STEP_SUMMARY
          echo "   - Extract and load in Chrome via \`chrome://extensions/\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "2. **Unzipped Extension** - \`extension-${{ github.event.inputs.environment }}-unzipped-v${{ github.run_number }}\`" >> $GITHUB_STEP_SUMMARY
          echo "   - Direct folder structure" >> $GITHUB_STEP_SUMMARY
          echo "   - Load directly in Chrome as unpacked extension" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“‹ Installation Instructions" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "1. Download the artifact from the **Artifacts** section above" >> $GITHUB_STEP_SUMMARY
          echo "2. Extract the ZIP file (if using ZIP package)" >> $GITHUB_STEP_SUMMARY
          echo "3. Open Chrome and go to \`chrome://extensions/\`" >> $GITHUB_STEP_SUMMARY
          echo "4. Enable **Developer mode** (top right)" >> $GITHUB_STEP_SUMMARY
          echo "5. Click **Load unpacked**" >> $GITHUB_STEP_SUMMARY
          echo "6. Select the extracted extension folder" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Retention:** Artifacts are kept for 90 days" >> $GITHUB_STEP_SUMMARY
